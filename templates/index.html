{% extends 'base.html' %}
{% block content %}

<!-- ═══════════════════════════════════════════════════
     ממוצע ליום
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow mb-3 kpi-card {% if per_day > 50 %}kpi-good{% elif per_day >= 35 %}kpi-warning{% else %}kpi-bad{% endif %}">
  <div class="card-body text-center text-white py-4">
    <div class="kpi-number" dir="ltr">€{{ "%.2f"|format(per_day) }}</div>
    <div class="kpi-label">ממוצע ליום עד לסוף תקופה</div>
    <div class="kpi-sub mt-2">
      <span class="me-3"><i class="bi bi-calendar3"></i> {{ days }} ימים עד ה-25</span>
      <span dir="ltr"><i class="bi bi-wallet2"></i> €{{ "%.2f"|format(remaining) }} נשאר</span>
    </div>
    <div class="kpi-month mt-1">{{ today.strftime('%B %Y') }}</div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════
     עדכון עו"ש + בעו"ש לא להתייחס
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header section-header">
    <i class="bi bi-bank2 text-primary"></i> עדכון עו"ש
  </div>
  <div class="card-body">
    <form method="POST" action="/update-balance">

      <!-- Row 1: עו"ש + עו"ש עתידי -->
      <div class="row g-2 align-items-end mb-2">
        <div class="col-5">
          <label class="form-label small text-muted mb-1">עו"ש</label>
          <div class="input-group" dir="ltr">
            <span class="input-group-text">€</span>
            <input type="number" step="0.01" class="form-control" name="balance"
                   value="{{ balance }}" />
          </div>
        </div>
        <div class="col-5">
          <label class="form-label small text-muted mb-1">עו"ש עתידי</label>
          <div class="input-group" dir="ltr">
            <span class="input-group-text">€</span>
            <input type="number" step="0.01" class="form-control" name="future"
                   value="{{ future }}" />
          </div>
        </div>
        <div class="col-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-check-lg"></i>
          </button>
        </div>
      </div>

      <!-- Row 2: בעו"ש לא להתייחס with freeze indicator -->
      <div class="row g-2 align-items-center">
        <div class="col-5">
          <label class="form-label small text-muted mb-1">בעו"ש לא להתייחס</label>
          <div class="input-group" dir="ltr">
            <span class="input-group-text">€</span>
            <input type="number" step="0.01" class="form-control" name="savings_ignore"
                   value="{{ savings_ignore }}" />
          </div>
        </div>
        <div class="col-7 pt-3">
          <span class="text-muted small">
            תחילת חודש: <span dir="ltr">€{{ "%.2f"|format(savings_ignore_at_reset) }}</span>
            {% set diff = savings_ignore - savings_ignore_at_reset %}
            {% if diff != 0 %}
              <span class="fw-bold {% if diff > 0 %}text-success{% else %}text-danger{% endif %}" dir="ltr">
                ({% if diff > 0 %}+{% endif %}€{{ "%.2f"|format(diff) }})
              </span>
            {% endif %}
          </span>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════
     הכנסות
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header section-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-arrow-down-circle-fill text-success"></i> הכנסות</span>
    {% if income_pending_total %}
      <span class="badge bg-success fs-6" dir="ltr">+€{{ "%.2f"|format(income_pending_total) }}</span>
    {% endif %}
  </div>
  <ul class="list-group list-group-flush">
    {% for item in income_items %}
      <li class="list-group-item {% if item.is_cleared %}cleared-item{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="item-name">{{ item.name }}</span>
            {% if item.is_cleared %}
              <span class="badge bg-secondary me-1">התקבל ✓</span>
            {% endif %}
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="fw-bold {% if not item.is_cleared %}text-success{% endif %}" dir="ltr">
              {% if item.amount %}+€{{ "%.2f"|format(item.amount) }}{% else %}—{% endif %}
            </span>
            <form method="POST"
                  action="{{ url_for('unclear_expense', expense_id=item.id) if item.is_cleared else url_for('clear_expense', expense_id=item.id) }}"
                  class="d-inline">
              <button type="submit"
                      class="btn btn-sm {% if item.is_cleared %}btn-outline-secondary{% else %}btn-outline-success{% endif %}">
                <i class="bi {% if item.is_cleared %}bi-x-circle{% else %}bi-check-circle{% endif %}"></i>
              </button>
            </form>
          </div>
        </div>

        <!-- Editable amount for variable/cleared-none income items -->
        {% if not item.is_cleared %}
          <form method="POST" action="/update-expense-amount/{{ item.id }}"
                class="mt-1 d-flex gap-1 align-items-center amount-edit-form">
            <label class="small text-muted mb-0">עדכן סכום:</label>
            <div class="input-group input-group-sm" dir="ltr" style="max-width:130px">
              <span class="input-group-text">€</span>
              <input type="number" step="0.01" class="form-control"
                     name="amount" value="{{ item.amount or '' }}" placeholder="סכום" />
            </div>
            <button type="submit" class="btn btn-sm btn-outline-secondary">OK</button>
          </form>
        {% endif %}
      </li>
    {% else %}
      <li class="list-group-item text-center text-muted py-3">
        אין פריטים — בצע <a href="/month-reset">איפוס חודש</a> תחילה
      </li>
    {% endfor %}
  </ul>
</div>

<!-- ═══════════════════════════════════════════════════
     הוצאות
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header section-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-arrow-up-circle-fill text-danger"></i> הוצאות</span>
    {% if expense_pending_total %}
      <span class="badge bg-danger fs-6" dir="ltr">-€{{ "%.2f"|format(expense_pending_total) }}</span>
    {% endif %}
  </div>
  <ul class="list-group list-group-flush">
    {% for item in expense_items %}
      <li class="list-group-item {% if item.is_cleared %}cleared-item{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="item-name">{{ item.name }}</span>
            {% if item.debit_day and not item.is_cleared %}
              <span class="badge bg-light text-dark border me-1">{{ item.debit_day }} לחודש</span>
            {% endif %}
            {% if item.is_cleared %}
              <span class="badge bg-secondary me-1">חויב ✓</span>
            {% endif %}
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="fw-bold {% if not item.is_cleared %}text-danger{% endif %}" dir="ltr">
              {% if item.amount %}-€{{ "%.2f"|format(item.amount) }}{% else %}—{% endif %}
            </span>
            <form method="POST"
                  action="{{ url_for('unclear_expense', expense_id=item.id) if item.is_cleared else url_for('clear_expense', expense_id=item.id) }}"
                  class="d-inline">
              <button type="submit"
                      class="btn btn-sm {% if item.is_cleared %}btn-outline-secondary{% else %}btn-outline-danger{% endif %}">
                <i class="bi {% if item.is_cleared %}bi-x-circle{% else %}bi-check-circle{% endif %}"></i>
              </button>
            </form>
          </div>
        </div>

        <!-- Editable amount for non-cleared expenses (partial charges, variable items) -->
        {% if not item.is_cleared %}
          <form method="POST" action="/update-expense-amount/{{ item.id }}"
                class="mt-1 d-flex gap-1 align-items-center amount-edit-form">
            <label class="small text-muted mb-0">עדכן סכום:</label>
            <div class="input-group input-group-sm" dir="ltr" style="max-width:130px">
              <span class="input-group-text">€</span>
              <input type="number" step="0.01" class="form-control"
                     name="amount" value="{{ item.amount or '' }}" placeholder="סכום" />
            </div>
            <button type="submit" class="btn btn-sm btn-outline-secondary">OK</button>
          </form>
        {% endif %}
      </li>
    {% else %}
      <li class="list-group-item text-center text-muted py-3">
        אין פריטים — בצע <a href="/month-reset">איפוס חודש</a> תחילה
      </li>
    {% endfor %}
  </ul>
</div>

<!-- ═══════════════════════════════════════════════════
     אשראי גדול לא בחשבון
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-header section-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-clock-history text-warning"></i> אשראי גדול לא בחשבון</span>
    {% if pending_total %}
      <span class="badge bg-warning text-dark fs-6" dir="ltr">-€{{ "%.2f"|format(pending_total) }}</span>
    {% endif %}
  </div>

  {% if pending_transactions %}
    <ul class="list-group list-group-flush">
      {% for pt in pending_transactions %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ pt.name }}</span>
          <div class="d-flex align-items-center gap-2">
            <span class="fw-bold text-danger" dir="ltr">-€{{ "%.2f"|format(pt.amount) }}</span>
            <form method="POST" action="/delete-pending/{{ pt.id }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-outline-success" title="הופיע בבנק — הסר">
                <i class="bi bi-check-circle"></i>
              </button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="card-body {% if pending_transactions %}border-top{% endif %} pt-2">
    <form method="POST" action="/add-pending" class="row g-2 align-items-center">
      <div class="col-5">
        <input type="text" class="form-control form-control-sm" name="name" placeholder="למשל: אמזון" />
      </div>
      <div class="col-4">
        <div class="input-group input-group-sm" dir="ltr">
          <span class="input-group-text">€</span>
          <input type="number" step="0.01" class="form-control" name="amount" placeholder="סכום" />
        </div>
      </div>
      <div class="col-3">
        <button type="submit" class="btn btn-warning btn-sm w-100">
          <i class="bi bi-plus-lg"></i> הוסף
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════
     פירוט חישוב
════════════════════════════════════════════════════ -->
<div class="card border-0 shadow-sm mb-5">
  <div class="card-header section-header">פירוט חישוב</div>
  <div class="card-body">
    <div class="d-flex justify-content-between small">
      <span class="text-muted">עו"ש + עו"ש עתידי</span>
      <span dir="ltr">€{{ "%.2f"|format(balance + future) }}</span>
    </div>
    <div class="d-flex justify-content-between small">
      <span class="text-muted">+ הכנסות צפויות</span>
      <span class="text-success" dir="ltr">+€{{ "%.2f"|format(income_pending_total) }}</span>
    </div>
    <div class="d-flex justify-content-between small">
      <span class="text-muted">− הוצאות עתידיות</span>
      <span class="text-danger" dir="ltr">-€{{ "%.2f"|format(expense_pending_total) }}</span>
    </div>
    <div class="d-flex justify-content-between small">
      <span class="text-muted">− אשראי לא בחשבון</span>
      <span class="text-danger" dir="ltr">-€{{ "%.2f"|format(pending_total) }}</span>
    </div>
    <div class="d-flex justify-content-between small">
      <span class="text-muted">− בעו"ש לא להתייחס</span>
      <span class="text-secondary" dir="ltr">-€{{ "%.2f"|format(savings_ignore) }}</span>
    </div>
    <hr class="my-1" />
    <div class="d-flex justify-content-between fw-bold">
      <span>= נשאר</span>
      <span class="{% if remaining >= 0 %}text-success{% else %}text-danger{% endif %}" dir="ltr">
        €{{ "%.2f"|format(remaining) }}
      </span>
    </div>
    <div class="d-flex justify-content-between fw-bold mt-1">
      <span>÷ {{ days }} ימים = ממוצע ליום</span>
      <span class="{% if per_day >= 0 %}text-success{% else %}text-danger{% endif %}" dir="ltr">
        €{{ "%.2f"|format(per_day) }}
      </span>
    </div>
  </div>
</div>

{% endblock %}
